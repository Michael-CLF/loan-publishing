<div class="login-container">
    <h2 class="title">Log in to Daily Loan Post</h2>

    <!-- VIEW 1: Email Entry (Initial State) -->
    @if (currentStep() === 'email') {
        <form [formGroup]="loginForm" (ngSubmit)="sendOTPCode()">
            <div class="form-group">
                <label for="email">Email Address</label>
                <input 
                    type="email" 
                    id="email" 
                    formControlName="email" 
                    placeholder="Enter your email address"
                    [disabled]="isLoading()"
                >
                @if (emailControl?.invalid && (emailControl?.dirty || emailControl?.touched)) {
                    <div class="error-message">
                        @if (emailControl?.errors?.['required']) {
                            <span>*Email is required</span>
                        }
                        @if (emailControl?.errors?.['email']) {
                            <span>*Please enter a valid email address</span>
                        }
                    </div>
                }
            </div>

            <button 
                type="submit" 
                [disabled]="loginForm.invalid || isLoading()" 
                class="login-button"
            >
                @if (isLoading()) {
                    <span>Sending Code...</span>
                } @else {
                    <span>Send Verification Code</span>
                }
            </button>

            <div class="divider">or continue with</div>

            <button 
                type="button"
                (click)="loginWithGoogle()" 
                class="google-signin-button"
                [disabled]="isLoading()"
            >
                <img src="assets/icons/google-logo.webp" alt="Google logo" />
                <span>Continue with Google</span>
            </button>

            <div class="login-options">
                <p>Don't have an account? <a (click)="openRoleSelectionModal()" style="cursor: pointer;">Sign up</a></p>
            </div>
        </form>

        <!-- Error Message for Email Entry -->
        @if (errorMessage()) {
            <div class="error-alert">
                <span class="error-icon">⚠️</span>
                <span>{{ errorMessage() }}</span>
            </div>
        }
    }

    <!-- VIEW 2: Code Entry -->
    @if (currentStep() === 'code') {
        <div class="code-entry-container">
            <div class="code-header">
                <h3>Check Your Email</h3>
                <p class="email-sent-to">
                    We sent a verification code to<br>
                    <strong>{{ loginForm.get('email')?.value }}</strong>
                </p>
            </div>

            <!-- 6-Digit Code Input Boxes -->
            <div class="code-input-group">
                @for (digit of codeDigits(); track $index) {
                    <input
                        type="text"
                        inputmode="numeric"
                        maxlength="1"
                        class="code-digit-input"
                        [id]="'code-' + $index"
                        [value]="digit"
                        (input)="onCodeDigitInput($index, $event)"
                        (keydown)="onCodeDigitKeydown($index, $event)"
                        (paste)="$index === 0 ? onCodePaste($event) : null"
                        [disabled]="isLoading()"
                        autocomplete="off"
                    />
                }
            </div>

            <!-- Timer and Actions -->
            <div class="code-actions">
                @if (!otpService.isExpired()) {
                    <p class="timer-text">
                        Code expires in: <strong>{{ timeRemaining() }}</strong>
                    </p>
                } @else {
                    <p class="timer-text expired">
                        ⏰ Code has expired. Please request a new one.
                    </p>
                }

                <button 
                    type="button"
                    (click)="verifyOTPCode()" 
                    class="verify-button"
                    [disabled]="isLoading() || codeDigits().join('').length !== 6 || otpService.isExpired()"
                >
                    @if (isLoading()) {
                        <span>Verifying...</span>
                    } @else {
                        <span>Verify Code</span>
                    }
                </button>

                <button 
                    type="button"
                    (click)="resendOTPCode()" 
                    class="resend-button"
                    [disabled]="isLoading()"
                >
                    Didn't receive it? Resend code
                </button>

                <button 
                    type="button"
                    (click)="goBackToEmail()" 
                    class="back-button"
                >
                    ← Use different email
                </button>
            </div>

            <!-- Error Message for Code Entry -->
            @if (errorMessage()) {
                <div class="error-alert">
                    <span class="error-icon">⚠️</span>
                    <span>{{ errorMessage() }}</span>
                    @if (attemptsRemaining() > 0) {
                        <span class="attempts-remaining">
                            ({{ attemptsRemaining() }} attempts remaining)
                        </span>
                    }
                </div>
            }
        </div>
    }

    <!-- VIEW 3: Verifying -->
    @if (currentStep() === 'verifying') {
        <div class="verification-message">
            <h3>Verifying your code...</h3>
            <div class="loader"></div>
            <p class="verification-text">Please wait while we verify your code</p>
        </div>
    }
</div>