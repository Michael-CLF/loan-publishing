<div class="registration-container">
  <h2 class="title">Lender Registration</h2>

  <div class="steps-container">
    <div class="step" [ngClass]="{'active': currentStep === 0, 'completed': currentStep > 0}">
      Contact Information
    </div>
    <div class="step" [ngClass]="{'active': currentStep === 1, 'completed': currentStep > 1}">
      Product Details
    </div>
    <div class="step" [ngClass]="{'active': currentStep === 2, 'completed': currentStep > 2}">
      Lending Footprint
    </div>
    <div class="step" [ngClass]="{'active': currentStep === 3, 'completed': currentStep > 3}">
      Review
    </div>
    <div class="step" [ngClass]="{'active': currentStep === 4, 'completed': currentStep > 4}">
      Verify Email
    </div>
    <div class="step" [ngClass]="{'active': currentStep === 5}">
      Payment
    </div>
  </div>

  <div class="form-container">
    <form [formGroup]="lenderForm">
      @if (currentStep === 0) {
      <app-lender-contact [lenderForm]="contactForm" [states]="states" (couponValidated)="onCouponValidated($event)">
      </app-lender-contact>
      } @else if (currentStep === 1) {
      <app-lender-product [lenderForm]="productForm" [lenderTypes]="lenderTypes"
        [propertyCategories]="propertyCategories" [states]="states" [loanTypes]="loanTypes"></app-lender-product>
      } @else if (currentStep === 2) {
      <app-lender-footprint [lenderForm]="footprintForm" [footprintLocation]="states">
      </app-lender-footprint>
      } @else if (currentStep === 3) {
      <app-lender-review [lenderForm]="lenderForm" [states]="states" [lenderTypes]="lenderTypes"
        [propertyCategories]="propertyCategories" [loanTypes]="loanTypes">
      </app-lender-review>
      } @else if (currentStep === 4) {
      <!-- OTP VERIFICATION STEP -->
      <div class="otp-verification-section">
        <h3 class="verify-txt">Verify Your Email</h3>
        <p class="instruction-txt mb-4">We've sent a 6-digit code to {{ registeredEmail }}.<br> Please enter it below:</p>
        
        <div class="otp-input-container d-flex justify-content-center gap-2 mb-4">
          @for (digit of [0,1,2,3,4,5]; track digit) {
            <input
              type="text"
              class="otp-input"
              [id]="'code-' + digit"
              maxlength="1"
              [(ngModel)]="codeDigits[digit]"
              [ngModelOptions]="{standalone: true}"
              (input)="onCodeDigitInput(digit, $event)"
              (keydown)="onCodeDigitKeydown(digit, $event)"
              (paste)="onCodePaste($event)"
              autocomplete="off"
            />
          }
        </div>

        @if (otpErrorMessage) {
        <div class="alert alert-danger">{{ otpErrorMessage }}</div>
        }

        <div class="text-center">
          <button type="button" class="btn btn-link" (click)="resendOTP()" [disabled]="otpIsLoading">
            Resend Code
          </button>
        </div>
      </div>
      } @else if (currentStep === 5) {
      <app-lender-stripe-payment [lenderData]="getLenderData()" (paymentComplete)="handlePaymentComplete($event)"
        (paymentError)="handlePaymentError($event)" #paymentComponent>
      </app-lender-stripe-payment>
      }

      @if (errorMessage) {
      <div class="error-message">{{ errorMessage }}</div>
      }

      @if (successMessage) {
      <div class="success-message">{{ successMessage }}</div>
      }

      <div class="button-container">
        @if (currentStep > 0 && currentStep !== 4) {
        <button type="button" class="btn btn-secondary" (click)="prevStep()">
          Previous
        </button>
        }

        @if (currentStep >= 0 && currentStep <= 2) { 
        <button type="button" class="btn btn-primary" id="next-btn"
          (click)="nextStep()" 
          [disabled]="
            (currentStep === 0 && contactForm.invalid) ||
            (currentStep === 1 && productForm.invalid) ||
            (currentStep === 2 && footprintForm.invalid)
          ">
          Next
        </button>
        }

      @if (currentStep === 3) {
        <button type="button" class="btn btn-success" id="proceed-to-verify-btn"
          [disabled]="!lenderForm.get('termsAccepted')?.value || isRegistering" 
          (click)="nextStep()">
          @if (!isRegistering) {
            <span>Proceed to Verification</span>
          }
          @if (isRegistering) {
            <span>Creating Account...</span>
          }
        </button>
        }

      @if (currentStep === 4) {
        <button type="button" class="btn btn-primary" 
          [disabled]="otpIsLoading || codeDigits.join('').length !== 6" 
          (click)="verifyOTPCode()">
          @if (!otpIsLoading) {
            <span>Verify Code</span>
          }
          @if (otpIsLoading) {
            <span>Verifying...</span>
          }
        </button>
        }

        @if (currentStep === 5) {
        <button type="button" class="btn btn-success" [disabled]="isLoading" (click)="submitForm()">
          <span *ngIf="!isLoading">Complete Registration</span>
          <span *ngIf="isLoading">Processing...</span>
        </button>
        }
      </div>
    </form>
  </div>
</div>