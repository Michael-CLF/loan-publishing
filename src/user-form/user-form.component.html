<div class="registration-container">

  <!-- STEP 1: REGISTRATION FORM -->
  @if (currentStep === 'form') {
    <form [formGroup]="userForm" novalidate class="registration-form">

      <!-- Contact / Company Info Section -->
      <div class="form-row">
        <div class="form-group">
          <label for="firstName">First Name</label>
          <input
            id="firstName"
            type="text"
            formControlName="firstName"
            placeholder="First Name"
          />
          @if (userForm.get('firstName')?.invalid && (userForm.get('firstName')?.dirty || userForm.get('firstName')?.touched)) {
            <div class="error-message">
              @if (userForm.get('firstName')?.errors?.['required']) {
                <span>*First name is required</span>
              }
              @if (userForm.get('firstName')?.errors?.['minlength']) {
                <span>*Minimum 2 characters</span>
              }
              @if (userForm.get('firstName')?.errors?.['pattern']) {
                <span>*Letters only</span>
              }
            </div>
          }
        </div>

        <div class="form-group">
          <label for="lastName">Last Name</label>
          <input
            id="lastName"
            type="text"
            formControlName="lastName"
            placeholder="Last Name"
          />
          @if (userForm.get('lastName')?.invalid && (userForm.get('lastName')?.dirty || userForm.get('lastName')?.touched)) {
            <div class="error-message">
              @if (userForm.get('lastName')?.errors?.['required']) {
                <span>*Last name is required</span>
              }
              @if (userForm.get('lastName')?.errors?.['minlength']) {
                <span>*Minimum 2 characters</span>
              }
              @if (userForm.get('lastName')?.errors?.['pattern']) {
                <span>*Letters only</span>
              }
            </div>
          }
        </div>
      </div>

      <div class="form-row">
        <div class="form-group full-width">
          <label for="company">Company</label>
          <input
            id="company"
            type="text"
            formControlName="company"
            placeholder="Company Name"
          />
          @if (userForm.get('company')?.invalid && (userForm.get('company')?.dirty || userForm.get('company')?.touched)) {
            <div class="error-message">
              @if (userForm.get('company')?.errors?.['required']) {
                <span>*Company is required</span>
              }
              @if (userForm.get('company')?.errors?.['minlength']) {
                <span>*Minimum 2 characters</span>
              }
              @if (userForm.get('company')?.errors?.['pattern']) {
                <span>*Letters and numbers only</span>
              }
            </div>
          }
        </div>
      </div>

      <!-- Contact details -->
      <div class="form-row">
        <div class="form-group">
          <label for="email">Email</label>
          <input
            id="email"
            type="email"
            formControlName="email"
            placeholder="you@example.com"
          />
          @if (userForm.get('email')?.invalid && (userForm.get('email')?.dirty || userForm.get('email')?.touched)) {
            <div class="error-message">
              @if (userForm.get('email')?.errors?.['required']) {
                <span>*Email is required</span>
              }
              @if (userForm.get('email')?.errors?.['email']) {
                <span>*Enter a valid email</span>
              }
              @if (userForm.get('email')?.errors?.['emailTaken']) {
                <span>*Email is already registered</span>
              }
            </div>
          }
        </div>

        <div class="form-group">
          <label for="phone">Phone</label>
          <input
            id="phone"
            type="tel"
            formControlName="phone"
            placeholder="(555) 555-5555"
            (input)="formatPhoneNumber()"
          />
          @if (userForm.get('phone')?.invalid && (userForm.get('phone')?.dirty || userForm.get('phone')?.touched)) {
            <div class="error-message">
              @if (userForm.get('phone')?.errors?.['required']) {
                <span>*Phone is required</span>
              }
              @if (userForm.get('phone')?.errors?.['minlength']) {
                <span>*Enter a valid phone number</span>
              }
              @if (userForm.get('phone')?.errors?.['pattern']) {
                <span>*Enter a valid phone number</span>
              }
            </div>
          }
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="city">City</label>
          <input
            id="city"
            type="text"
            formControlName="city"
            placeholder="City"
          />
          @if (userForm.get('city')?.invalid && (userForm.get('city')?.dirty || userForm.get('city')?.touched)) {
            <div class="error-message">
              @if (userForm.get('city')?.errors?.['required']) {
                <span>*City is required</span>
              }
              @if (userForm.get('city')?.errors?.['minlength']) {
                <span>*Minimum 2 characters</span>
              }
              @if (userForm.get('city')?.errors?.['pattern']) {
                <span>*Letters only</span>
              }
            </div>
          }
        </div>

        <div class="form-group">
          <label for="state">State</label>
          <select id="state" formControlName="state">
            <option value="" disabled>Select State</option>
            @for (stateOpt of states; track stateOpt.value) {
              <option [value]="stateOpt.value">{{ stateOpt.name }}</option>
            }
          </select>
          @if (userForm.get('state')?.invalid && (userForm.get('state')?.dirty || userForm.get('state')?.touched)) {
            <div class="error-message">
              <span>*State is required</span>
            </div>
          }
        </div>
      </div>

      <!-- Billing choice -->
      <div class="billing-section">
        <label class="section-label">Billing Interval</label>
        <div class="billing-options">
          <label class="billing-option">
            <input
              type="radio"
              formControlName="interval"
              value="monthly"
              (change)="selectBilling('monthly')"
            />
            <span>Monthly</span>
          </label>

          <label class="billing-option">
            <input
              type="radio"
              formControlName="interval"
              value="annually"
              (change)="selectBilling('annually')"
            />
            <span>Annually</span>
          </label>
        </div>
      </div>

      <!-- Promo code / coupon -->
      <div class="coupon-row">
        <div class="form-group promo-group">
          <label for="promotion_code">Promotion Code</label>
          <div class="promo-inline">
            <input
              id="promotion_code"
              type="text"
              formControlName="promotion_code"
              placeholder="Optional"
              (blur)="validateCoupon()"
            />
            <button
              type="button"
              class="apply-btn"
              [disabled]="isValidatingCoupon"
              (click)="validateCoupon()"
            >
              @if (isValidatingCoupon) {
                <span>Applying...</span>
              } @else {
                <span>Apply</span>
              }
            </button>
          </div>

          <!-- coupon state feedback -->
          @if (couponApplied && appliedCouponDetails) {
            <div class="coupon-success">
              <strong>{{ appliedCouponDetails.displayCode || appliedCouponDetails.code }}</strong>
              <span> applied:
                @if (appliedCouponDetails.discountType === 'percentage') {
                  {{ appliedCouponDetails.discount }}% off
                } @else {
                  ${{ appliedCouponDetails.discount }} off
                }
              </span>
              @if (appliedCouponDetails.description) {
                <div class="coupon-desc">{{ appliedCouponDetails.description }}</div>
              }
            </div>
          }
        </div>
      </div>

      <!-- Terms of Service -->
      <div class="tos-row">
        <label class="tos-check">
          <input
            type="checkbox"
            formControlName="tos"
          />
          <span>
            I have read, acknowledge and agree to the Terms of Service
          </span>
        </label>
        @if (userForm.get('tos')?.invalid && (userForm.get('tos')?.dirty || userForm.get('tos')?.touched)) {
          <div class="error-message">
            <span>*You must agree to continue</span>
          </div>
        }
      </div>

      <!-- Pricing summary -->
      <div class="plan-summary-box">
        <div class="plan-summary-row">
          <div class="plan-summary-label">Plan:</div>
          <div class="plan-summary-value">
            {{ userForm.get('interval')?.value === 'annually'
              ? 'Originator Annual'
              : 'Originator Monthly' }}
          </div>
        </div>

        <div class="plan-summary-row total-row">
          <div class="plan-summary-label">Total:</div>
          <div class="plan-summary-value">
            {{ userForm.get('interval')?.value === 'annually'
              ? '$1,610.00/year'
              : '$99.00/month' }}
          </div>
        </div>
      </div>

      <!-- Submit button -->
      <div class="button-container full-width">
        <button
          type="button"
          id="originator"
          class="originator-btn"
          [disabled]="userForm.invalid || isLoading"
          (click)="onSubmit()"
        >
          @if (!isLoading) {
            <span>Register</span>
          } @else {
            <span>Registering...</span>
          }
        </button>
      </div>

      <!-- top-level error from onSubmit -->
      @if (errorMessage) {
        <div class="error-message global-error">
          {{ errorMessage }}
        </div>
      }
    </form>
  }

  <!-- STEP 2: OTP ENTRY -->
  @if (currentStep === 'otp') {
    <div class="code-entry-container otp-card">
      <div class="code-header">
        <h3 class="otp-title">Complete Your Registration</h3>
        <p class="otp-subtitle">Check Your Email</p>
        <p class="email-sent-to">
          We sent a verification code to
          <strong>{{ registeredEmail }}</strong>
        </p>
      </div>

      <!-- 6-digit code input row, same pattern as login -->
      <div class="code-input-group">
        @for (digit of codeDigits; track $index) {
          <input
            type="text"
            inputmode="numeric"
            maxlength="1"
            class="code-digit-input"
            [id]="'code-' + $index"
            [value]="digit"
            (input)="onCodeDigitInput($index, $event)"
            (keydown)="onCodeDigitKeydown($index, $event)"
            (paste)="$index === 0 ? onCodePaste($event) : null"
            [disabled]="otpIsLoading"
            autocomplete="off"
          />
        }
      </div>

      <div class="code-timer">
        Code expires in:
        <strong>{{ timeRemaining }}</strong>
      </div>

      <div class="code-actions">
        <button
          type="button"
          class="verify-button"
          [disabled]="otpIsLoading || codeDigits.join('').length !== 6"
          (click)="verifyOTPCode()"
        >
          @if (otpIsLoading) {
            <span>Verifying...</span>
          } @else {
            <span>Verify Code</span>
          }
        </button>

        <button
          type="button"
          class="resend-button"
          [disabled]="otpIsLoading"
          (click)="resendOTPCode()"
        >
          Didn't receive it? Resend code
        </button>
      </div>

      @if (otpErrorMessage) {
        <div class="error-alert">
          <span class="error-icon">⚠️</span>
          <span>{{ otpErrorMessage }}</span>
        </div>
      }
    </div>
  }

  <!-- STEP 3: VERIFYING / REDIRECTING -->
  @if (currentStep === 'verifying') {
    <div class="verification-message">
      <h3>Verifying your code…</h3>
      <div class="loader"></div>
      <p class="verification-text">
        Please wait. You will be redirected to payment.
      </p>
    </div>
  }

</div>
